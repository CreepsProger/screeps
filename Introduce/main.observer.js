/*
Script
Console
Memory
Resume¬†tracking
 
[17:44:50]
[shard1]
‚è≥ 3382 2073 {"max_dt":58.456,"creep":"creep-<5341/0>-33c17m-507731","role":"energy_harvesting","step":"getTarget","dt":58.456,"t":106.561} 82 {"x":44,"y":9,"roomName":"W27S24"} {"id":"5facc2142139da398c81bb46","pos":{"x":44,"y":10,"roomName":"W27S24"},"time":33822061}
[17:44:50]
[shard1]
‚è≥ 3382 2073 {"max_dt":58.923,"creep":"creep-<5341/0>-33c17m-507731","role":"energy_harvesting","dt":58.923,"t":106.396} 82 {"x":44,"y":9,"roomName":"W27S24"} {"id":"5facc2142139da398c81bb46","pos":{"x":44,"y":10,"roomName":"W27S24"},"time":33822061}
[17:44:50]
[shard1]
‚è≥ 3382 2073 {"max_dt":59.43,"creep":"creep-<5341/0>-33c17m-507731","dt":59.43,"t":105.926,"n":82} 82 {"x":44,"y":9,"roomName":"W27S24"} {"id":"5facc2142139da398c81bb46","pos":{"x":44,"y":10,"roomName":"W27S24"},"time":33822061}
[17:44:59]
[shard1]
üëÄ 3382 2074 {"main":"observeRoom","room":"W30S29","od_room":{"lst_time":33822074}}
[17:44:59]
[shard1]
üëÄ 3382 2074 {"main":"observeRoom","room":"W26S30","od_room":{"lst_time":33822074}}
[17:44:59]
[shard1]
üëÄ 3382 2074 {"main":"observeRoom","room":"W20S24","od_room":{"lst_time":33822074}}
[17:44:59]
[shard1]
üëÄ 3382 2074 {"main":"observeRoom","room":"W28S30","od_room":{"lst_time":33822074}}
[17:44:59]
[shard1]
üëÄ 3382 2074 {"main":"observeRoom","room":"W30S32","od_room":{"lst_time":33822074}}
[17:44:59]
[shard1]
üëÄ 3382 2074 {"main":"observeRoom","room":"W19S30","od_room":{"lst_time":33822074}}
[17:44:59]
[shard1]
üëÄ 3382 2074 {"main":"observeRoom","room":"W23S30","od_room":{"lst_time":33822074}}
[17:44:59]
[shard1]
üëÄ 3382 2074 {"main":"observeRoom","room":"W30S26","od_room":{"lst_time":33822074}}
[17:44:59]
[shard1]
‚è≥ 3382 2074 {"max_dt":8.785,"creep":"creep-<5121/0>-33c17m-507753","role":"energy_harvesting","dt":8.785,"t":54.675} 33 {"x":13,"y":20,"roomName":"W24S28"} {"id":"6066d0764ee2582abd1ec2c2","pos":{"x":44,"y":5,"roomName":"W24S28"},"time":33822074}
[17:44:59]
[shard1]
‚è≥ 3382 2074 {"max_dt":8.998,"creep":"creep-<5121/0>-33c17m-507753","dt":8.998,"t":54.531,"n":33} 33 {"x":13,"y":20,"roomName":"W24S28"} {"id":"6066d0764ee2582abd1ec2c2","pos":{"x":44,"y":5,"roomName":"W24S28"},"time":33822074}
[17:44:59]
[shard1]
‚è≥ 3382 2074 {"max_dt":62.319,"creep":"creep-<5141/0>-32c16m-507700","role":"energy_harvesting","step":"getTarget","dt":62.319,"t":67.736} 39 {"x":3,"y":30,"roomName":"W27S26"} {"id":"5f8aa6c618efff77085cb17e","pos":{"x":2,"y":30,"roomName":"W27S26"},"time":33822054}
[17:44:59]
[shard1]
‚è≥ 3382 2074 {"max_dt":62.766,"creep":"creep-<5141/0>-32c16m-507700","role":"energy_harvesting","dt":62.766,"t":67.586} 39 {"x":3,"y":30,"roomName":"W27S26"} {"id":"5f8aa6c618efff77085cb17e","pos":{"x":2,"y":30,"roomName":"W27S26"},"time":33822054}
[17:44:59]
[shard1]
‚è≥ 3382 2074 {"max_dt":63.526,"creep":"creep-<5141/0>-32c16m-507700","dt":63.526,"t":66.864,"n":39} 39 {"x":3,"y":30,"roomName":"W27S26"} {"id":"5f8aa6c618efff77085cb17e","pos":{"x":2,"y":30,"roomName":"W27S26"},"time":33822054}
[17:46:41]
[shard1]
‚úíÔ∏è 3382 2075 Clearing non-existing creep memory: creep-<5501/2>-25c25m-507648 5501 sum idle pst: 0 {} total_sum_pst: 1769 total_cnt_pst: 111 total_avg_pst: 16 {"0":{},"11":{},"14":{},"15":{},"16":{},"20":{},"24":{},"63":{},"172":{},"173":{},"200":{},"201":{},"202":{},"203":{},"204":{},"205":{},"206":{},"207":{},"208":{},"209":{},"210":{},"211":{},"214":{},"216":{},"217":{},"218":{},"219":{},"226":{},"227":{},"228":{},"230":{},"231":{},"232":{},"233":{},"234":{},"235":{},"403":{},"501":{},"502":{},"503":{},"504":{},"505":{},"506":{},"507":{},"508":{},"509":{},"510":{},"511":{},"512":{},"513":{},"514":{},"5011":{"507756":{"i":1,"lt":155,"pc":1,"w":5011}},"5013":{},"5014":{"507675":{"i":214,"lt":1273,"pc":17,"w":5014}},"5015":{},"5016":{},"5017":{},"5020":{"304":{"i":4,"lt":13,"pc":31,"w":5020},"330":{"i":4,"lt":17,"pc":24,"w":5020},"719":{"i":4,"lt":35,"pc":11,"w":5020},"832":{"i":2,"lt":10,"pc":20,"w":5020}},"5021":{"507674":{"i":9,"lt":871,"pc":1,"w":5021}},"5024":{"507729":{"i":250,"lt":625,"pc":40,"w":5024}},"5025":{},"5026":{},"5027":{},"5030":{},"5031":{"507685":{"i":71,"lt":1153,"pc":6,"w":5031}},"5034":{"507751":{"i":90,"lt":335,"pc":27,"w":5034}},"5035":{},"5036":{},"5040":{},"5041":{"507743":{"i":152,"lt":316,"pc":48,"w":5041}},"5044":{"507734":{"i":104,"lt":371,"pc":28,"w":5044}},"5050":0,"5051":{},"5054":{"507705":{"i":226,"lt":702,"pc":32,"w":5054}},"5055":{},"5056":{},"5057":{},"5060":{},"5061":{"507664":{"i":563,"lt":1332,"pc":42,"w":5061}},"5064":{"507715":{"i":403,"lt":902,"pc":45,"w":5064}},"5066":{},"5067":{},"5070":{},"5071":{"507677":{"i":201,"lt":1156,"pc":17,"w":5071}},"5074":{},"5076":{},"5077":{},"5080":{"4523":{"i":24,"lt":118,"pc":20,"w":5080},"9507":{"i":4,"lt":144,"pc":3,"w":5080}},"5081":{"507683":{"i":4,"lt":1134,"pc":0,"w":5081},"507704":{"i":2,"lt":884,"pc":0,"w":5081},"507716":{"i":1,"lt":260,"pc":0,"w":5081}},"5082":{},"5084":{"507702":{"i":155,"lt":904,"pc":17,"w":5084}},"5085":{},"5086":{},"5087":{},"5090":{"8885":{"i":8,"lt":143,"pc":6,"w":5090},"8886":{"i":8,"lt":144,"pc":6,"w":5090},"8902":{"i":8,"lt":144,"pc":6,"w":5090},"8904":{"i":8,"lt":145,"pc":6,"w":5090},"9333":{"i":8,"lt":144,"pc":6,"w":5090},"9334":{"i":8,"lt":147,"pc":5,"w":5090},"9351":{"i":10,"lt":148,"pc":7,"w":5090},"9353":{"i":8,"lt":136,"pc":6,"w":5090},"9414":{"i":8,"lt":140,"pc":6,"w":5090},"9418":{"i":8,"lt":142,"pc":6,"w":5090},"9437":{"i":10,"lt":145,"pc":7,"w":5090},"9467":{"i":8,"lt":140,"pc":6,"w":5090},"9470":{"i":8,"lt":141,"pc":6,"w":5090},"9771":{"i":10,"lt":150,"pc":7,"w":5090},"9773":{"i":8,"lt":141,"pc":6,"w":5090},"9976":{"i":8,"lt":141,"pc":6,"w":5090},"9979":{"i":8,"lt":138,"pc":6,"w":5090},"10019":{"i":8,"lt":142,"pc":6,"w":5090},"10022":{"i":8,"lt":141,"pc":6,"w":5090},"10286":{"i":8,"lt":142,"pc":6,"w":5090},"10288":{"i":10,"lt":138,"pc":7,"w":5090},"10307":{"i":8,"lt":140,"pc":6,"w":5090},"10317":{"i":8,"lt":137,"pc":6,"w":5090},"10330":{"i":8,"lt":149,"pc":5,"w":5090},"10359":{"i":8,"lt":141,"pc":6,"w":5090},"10361":{"i":8,"lt":148,"pc":5,"w":5090},"10604":{"i":8,"lt":139,"pc":6,"w":5090},"10611":{"i":8,"lt":143,"pc":6,"w":5090},"10621":{"i":10,"lt":144,"pc":7,"w":5090},"10626":{"i":8,"lt":142,"pc":6,"w":5090},"11812":{"i":8,"lt":142,"pc":6,"w":5090},"11813":{"i":8,"lt":94,"pc":9,"w":5090},"11885":{"i":8,"lt":94,"pc":9,"w":5090},"12014":{"i":10,"lt":90,"pc":11,"w":5090},"12106":{"i":10,"lt":98,"pc":10,"w":5090},"12196":{"i":10,"lt":95,"pc":11,"w":5090}},"5091":{},"5094":{"507690":{"i":484,"lt":1054,"pc":46,"w":5094}},"5095":{},"5096":{},"5097":{},"5100":{},"5101":{"507657":{"i":453,"lt":1446,"pc":31,"w":5101},"507735":{"i":232,"lt":449,"pc":52,"w":5101}},"5104":{"507671":{"i":372,"lt":1302,"pc":29,"w":5104}},"5106":{},"5110":{},"5111":{"507698":{"i":286,"lt":899,"pc":32,"w":5111},"507747":{"i":50,"lt":277,"pc":18,"w":5111}},"5114":{"507736":{"i":12,"lt":416,"pc":3,"w":5114}},"5116":{},"5117":{},"5120":{},"5121":{"507753":{"i":7,"lt":189,"pc":4,"w":5121}},"5124":{"507732":{"i":1,"lt":203,"pc":0,"w":5124},"507742":{"i":12,"lt":364,"pc":3,"w":5124}},"5125":{},"5126":{},"5130":{},"5131":{"507727":{"i":390,"lt":649,"pc":60,"w":5131}},"5134":{"507707":{"i":189,"lt":821,"pc":23,"w":5134}},"5136":{},"5140":{},"5141":{},"5142":{},"5144":{"507699":{"i":587,"lt":995,"pc":59,"w":5144}},"5145":{},"5146":{},"5147":{},"5150":{},"5151":{"507711":{"i":150,"lt":900,"pc":17,"w":5151}},"5154":{"507739":{"i":34,"lt":332,"pc":10,"w":5154}},"5155":{},"5156":{},"5157":{},"5160":{},"5161":{"507676":{"i":128,"lt":1269,"pc":10,"w":5161},"507696":{"i":55,"lt":850,"pc":6,"w":5161},"507723":{"i":42,"lt":562,"pc":7,"w":5161}},"5164":{},"5166":{},"5167":{},"5170":{},"5171":{"507673":{"i":430,"lt":1195,"pc":36,"w":5171},"507745":{"i":35,"lt":308,"pc":11,"w":5171}},"5174":{"507710":{"i":239,"lt":800,"pc":30,"w":5174}},"5176":{},"5177":{},"5180":{},"5181":{"507659":{"i":797,"lt":1434,"pc":56,"w":5181}},"5184":{},"5186":{},"5187":{},"5190":{},"5191":{"507649":{"i":21,"lt":1156,"pc":2,"w":5191}},"5194":{"507759":{"i":53,"lt":124,"pc":43,"w":5194}},"5195":{},"5196":{},"5200":{},"5201":{"507687":{"i":10,"lt":1080,"pc":1,"w":5201}},"5204":{"507752":{"i":113,"lt":224,"pc":50,"w":5204}},"5205":{},"5206":{},"5207":{},"5210":{},"5211":{},"5214":{"507744":{"i":16,"lt":343,"pc":5,"w":5214}},"5215":{},"5216":{},"5220":{},"5221":{"507722":{"i":406,"lt":706,"pc":58,"w":5221}},"5224":{"507750":{"i":93,"lt":336,"pc":28,"w":5224}},"5226":{},"5227":{},"5230":{},"5231":{"507694":{"i":123,"lt":1052,"pc":12,"w":5231}},"5234":{"507689":{"i":260,"lt":1092,"pc":24,"w":5234},"507758":{"i":33,"lt":142,"pc":23,"w":5234}},"5236":{},"5237":{},"5240":{},"5241":{"507703":{"i":324,"lt":910,"pc":36,"w":5241}},"5244":{"507757":{"i":11,"lt":240,"pc":5,"w":5244}},"5246":{},"5251":{},"5253":{},"5254":{},"5255":{},"5256":{},"5257":{},"5258":{},"5261":{},"5264":{},"5266":{},"5267":{},"5268":{},"5270":{},"5271":{},"5274":{"507672":{"i":1,"lt":569,"pc":0,"w":5274}},"5275":{},"5276":{},"5277":{},"5281":{},"5284":{},"5286":{},"5287":{},"5288":{},"5290":{},"5291":{"507697":{"i":147,"lt":993,"pc":15,"w":5291}},"5294":{"507686":{"i":247,"lt":1223,"pc":20,"w":5294}},"5300":{},"5301":{"507691":{"i":6,"lt":1073,"pc":1,"w":5301}},"5304":{},"5305":{},"5306":{},"5307":{},"5310":{},"5311":{"507658":{"i":117,"lt":1382,"pc":8,"w":5311}},"5314":{},"5316":{},"5321":{},"5324":{},"5326":{},"5327":{},"5328":{},"5340":{},"5341":{"507728":{"i":9,"lt":614,"pc":1,"w":5341}},"5344":{"507663":{"i":62,"lt":1354,"pc":5,"w":5344}},"5345":{},"5346":{},"5347":{},"5350":{},"5351":{"507713":{"i":96,"lt":825,"pc":12,"w":5351},"507741":{"i":60,"lt":386,"pc":16,"w":5351}},"5354":{},"5356":{},"5360":{},"5361":{},"5364":{"507714":{"i":139,"lt":907,"pc":15,"w":5364}},"5366":{},"5370":{},"5371":{"507701":{"i":164,"lt":932,"pc":18,"w":5371}},"5374":{"507692":{"i":284,"lt":1044,"pc":27,"w":5374}},"5376":{},"5377":{},"5400":{},"5401":{"507681":{"i":12,"lt":961,"pc":1,"w":5401},"507754":{"i":1,"lt":83,"pc":1,"w":5401}},"5402":{"507737":{"i":1,"lt":1,"pc":100,"w":5402}},"5404":{"507749":{"i":32,"lt":283,"pc":11,"w":5404}},"5405":{},"5406":{},"5407":{},"5408":{},"5410":{},"5411":{},"5412":{},"5413":{},"5414":{"507669":{"i":30,"lt":1277,"pc":2,"w":5414},"507712":{"i":23,"lt":7
*/
const constants = require('main.constants');
const terminals = require('main.terminals');
const config = require('main.config');
const tools = require('tools');
const cash = require('cash');

const observer = {

	getConfig: function(roomName) {
		return config.getObserverConfig(roomName);
	}
	
	, rooms: {}, 
	
	getDeposit: function(roomName) {
		const od_room = observer.rooms[roomName];
		return !!od_room? od_room.deposit:undefined;
	},
	
	getInviderCore: function(roomName) {
		const od_room = observer.rooms[roomName];
		return !!od_room? od_room.inviderCore :undefined;
	},
	
	shouldSpawnForDeposit: function(roomName) {
		return !!observer.getDeposit(roomName);
	},
	
	getInviderCoreLevel: function(roomName) {
		const od_inviderCore = observer.getInviderCore(roomName);
		if (!od_inviderCore)
			return undefined;
		return od_inviderCore.obj.level;
	},

	run: function() {
		
		cash.getAllMyObservers()
				.forEach(function(o,i) {
          const o_rooms = observer.getConfig(o.room.name);
          const o_room = o_rooms[Game.time%o_rooms.length];
					const err = o.observeRoom(o_room);
					if(observer.rooms[o_room] === undefined) {
						observer.rooms[o_room] = {lst_time:Game.time+1};
					}
					observer.rooms[o_room].lst_time = Game.time+1;
					if(err != OK) {
						console.log('üëÄüåÄ‚ö†Ô∏è', Math.trunc(Game.time/10000), Game.time%10000
																 , JSON.stringify({main:'observeRoom', room:o.room.name, o_room:o_room, err:err, o_rooms:o_rooms, observer:o}));
					}
		});
		
		Object.keys(observer.rooms).filter((roomName) => observer.rooms[roomName].lst_time == Game.time)
									.forEach(function(roomName,i) {
			const od_room = observer.rooms[roomName];
			const maxLastCooldown = 300;

			if(true) {
				console.log('üëÄ', Math.trunc(Game.time/10000), Game.time%10000
													, JSON.stringify({main:'observeRoom', room:roomName, od_room:od_room}));
			}
			
			if(!od_room.deposit || !od_room.deposit.obj) {
				if(Game.time%101 == 1) {
					const room = Game.rooms[roomName];
					const obj = room.find(FIND_DEPOSITS)
													.filter((d) => tools.nvl(d.lastCooldown,0) < maxLastCooldown)
													.sort((l,r) => (l.ticksToDecay < 10000) ? -1:
																					(r.ticksToDecay < 10000) ? 1:0)
													.shift();
					if(!!obj) {
						od_room.deposit = {obj:obj, id:obj.id};
						od_room.deposit.timeElapsCooldown = Game.time + obj.cooldown;
						console.log('‚ñ£üëÄ', Math.trunc(Game.time/10000), Game.time%10000
														, JSON.stringify({main:'observedRoom', roomName:roomName, deposit:od_room.deposit}));
					}
				}
			}
			else if(!!od_room.deposit.timeElapsCooldown && od_room.deposit.timeElapsCooldown <= Game.time) {
				od_room.deposit.obj = Game.getObjectById(od_room.deposit.id);
				od_room.deposit.timeElapsCooldown = Game.time + od_room.deposit.obj.cooldown;
				if(od_room.deposit.lastCooldown > maxLastCooldown) {
					od_room.deposit = undefined;
				}
				if(Game.time%100 == 1) {
					console.log('‚ñ£üëÄ', Math.trunc(Game.time/10000), Game.time%10000
										 			, JSON.stringify({main:'observedRoom', roomName:roomName, deposit:od_room.deposit}));
				}
			}

			if(!od_room.power || !od_room.power.obj) {
				if(Game.time%101 == 2) {
					const room = Game.rooms[roomName];
					const obj = room.find(FIND_HOSTILE_STRUCTURES)
													.filter((hs) => hs.structureType == STRUCTURE_POWER_BANK &&
																					tools.nvl(hs.ticksToDecay,0) > 5000)
													.shift();
					if(!!obj) {
						od_room.power = {obj:obj, id:obj.id};
						od_room.power.timeToDecay = Game.time + obj.ticksToDecay;
						od_room.power.timeElapsCooldown = Game.time + od_room.power.obj.cooldown;
						console.log('üî¥üëÄ', Math.trunc(Game.time/10000), Game.time%10000
														, JSON.stringify({main:'observedRoom', roomName:roomName, power:od_room.power}));
					}
				}
			}
			else if(!!od_room.power.timeElapsCooldown && od_room.power.timeElapsCooldown <= Game.time) {
				od_room.power.obj = Game.getObjectById(od_room.power.id);
				od_room.power.timeToDecay = Game.time + od_room.power.obj.ticksToDecay;
				od_room.power.timeElapsCooldown = Game.time + od_room.power.obj.cooldown;
				if(od_room.power.timeToDecay < Game.time) {
					od_room.power = undefined;
				}
				if(Game.time%101 == 2) {
					console.log('üî¥üëÄ', Math.trunc(Game.time/10000), Game.time%10000
													, JSON.stringify({main:'observedRoom', roomName:roomName, power:od_room.power}));
				}
			}
			
			if(!od_room.inviderCore || !od_room.inviderCore.obj) {
				if(Game.time%1 == 0) {
					const room = Game.rooms[roomName];
					const obj = room.find(FIND_HOSTILE_STRUCTURES, { filter: (hs) => hs.level !== undefined} )
													.shift();
					if(!!obj) {
						od_room.inviderCore = {obj:obj, id:obj.id};
						od_room.inviderCore.timeToDecay = Game.time + obj.ticksToDecay;
						console.log('üéÉüëÄ', Math.trunc(Game.time/10000), Game.time%10000
														, JSON.stringify({main:'observedRoom', roomName:roomName, inviderCore:od_room.inviderCore }));
					}
				}
			}
			else {
				od_room.inviderCore.obj = Game.getObjectById(od_room.inviderCore.id);
				od_room.inviderCore.timeToDecay = Game.time + od_room.inviderCore.obj.ticksToDecay;
				if(od_room.inviderCore.timeToDecay < Game.time) {
					od_room.inviderCore = undefined;
				}
				if(Game.time%1 == 0) {
					console.log('üéÉüëÄ', Math.trunc(Game.time/10000), Game.time%10000
													, JSON.stringify({main:'observedRoom', roomName:roomName, inviderCore:od_room.inviderCore}));
				}
			}

		});
		
	}
};

module.exports = observer
